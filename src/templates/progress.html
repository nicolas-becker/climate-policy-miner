<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Document - Transport Policy Miner</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .progress-container {
            max-width: 600px;
            margin: 100px auto;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 5px;
        }
        .status-text {
            margin-top: 15px;
            text-align: center;
        }
        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
        }
        .traceback {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            color: #212529;
            padding: 15px;
            border-radius: 4px;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            display: none;
        }
        .error-actions {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .copy-success {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
            color: #155724 !important;
        }
        .final-actions {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .large-doc-notice { 
        background-color: #e3f2fd; 
        padding: 15px; 
        border-radius: 5px; 
        margin: 20px 0; 
        border-left: 4px solid #2196F3;
        }
        .connection-status { 
            font-size: 14px; 
            color: #666; 
            margin-top: 10px; 
            text-align: center;
        }
        .error-details { 
            background-color: #ffebee; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 20px 0; 
            border-left: 4px solid #f44336; 
        }
        .partial-download { 
            background-color: #fff3e0; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0; 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Ensure sections have proper styling */
        #partial-results-container .card {
            transition: all 0.3s ease;
        }
        /* Stage indicator styling */
        .stage-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(0,0,0,0.1);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .verified-quote {
            border-left: 4px solid #198754;
            background-color: #f8fff8;
            border: 1px solid #d4edda;
        }

        .unverified-quote {
            border-left: 4px solid #dc3545;
            background-color: #fff5f5;
            border: 1px solid #f5c2c7;
        }

        .verified-quote .quote-text {
            color: #198754;
        }

        .unverified-quote .quote-text {
            color: #dc3545;
        }

        .quote-item {
            transition: all 0.2s ease;
        }

        .quote-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .verification-badge .badge {
            font-size: 0.75em;
            padding: 0.25em 0.5em;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="card-title text-center mb-4">üöçüåç Transport Policy Miner üìÉ‚õèÔ∏è</h1>
                
                <div class="alert alert-info" role="alert">
                    <h4><strong>Analysis in Progress</strong></h4>
                    <p class="mb-2">üìù Document: <strong>{{ original_filename or 'Loading...' }}</strong></p>
                    <p class="mb-2">üìå Task ID (for debugging purposes): <code>{{ task_id }}</code></p>
                    <!-- Pre-calculated document information -->
                    {% if document_pages != "unknown" and estimated_minutes != "unknown" %}
                        <div class="alert alert-secondary mt-3">
                            <h5>‚ú® Your document is being analyzed:</h5>
                            <p class="mb-1">üìÑ <strong>{{ document_pages }} pages</strong> detected</p>
                            <p class="mb-1">‚è±Ô∏è <strong>{{ estimated_minutes }} minute{{ 's' if estimated_minutes > 1 else '' }}</strong> estimated</p>
                            {% if encouragement %}
                                <p class="mb-0 text-muted">{{ encouragement }}</p>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="alert alert-secondary mt-3">
                            <p class="mb-0">‚è±Ô∏è Processing time will vary based on document size</p>
                        </div>
                    {% endif %}
                    <p><strong>Please keep this window open.</strong></p>
                </div>

                <div class="progress-container">
                    <h2 class="text-center mb-4">‚åõ Processing Document</h2>

                    <div class="progress" style="height: 25px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                            role="progressbar" style="width: 0%;" 
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <p id="status-text" class="status-text">Starting analysis...</p>
                    
                    <div id="error-container" style="display: none;">
                        <p class="text-center mt-3 mb-3"><strong>Pipeline was interrupted due to the following error:</strong></p>
                        
                        <!-- Red error box -->
                        <div class="error-message">
                            <p id="error-text" class="mb-0"></p>
                        </div>
                        
                        <!-- Error detail buttons -->
                        <div class="error-actions">
                            <button id="toggle-traceback" class="btn btn-outline-danger btn-sm">Show Full Error Details</button>
                            <button id="copy-error-btn" class="btn btn-outline-secondary btn-sm" onclick="copyErrorToClipboard()">
                                üìã Copy Error Details
                            </button>
                        </div>
                        
                        <!-- Traceback container -->
                        <div id="traceback-container" class="traceback"></div>
                        
                        <!-- Green partial results info box -->
                        <div id="partial-results-info" class="mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <strong>Partial Results Available:</strong>
                                <ul id="partial-results-list" class="mb-0 mt-2"></ul>
                            </div>
                        </div>
                        
                        <!-- Final action buttons -->
                        <div class="final-actions">
                            <button id="download-partial-btn" class="btn btn-warning btn-sm" style="display: none;" onclick="downloadPartialResults()">
                                üì¶ Download Partial Results
                            </button>
                            <a href="{{ url_for('index') }}" class="btn btn-primary">Return to Home</a>
                        </div>
                    </div>
                </div>
                <div id="partial-results-container" style="display: none;" class="mt-4">
    
                    <!-- Document Partitions Section -->
                    <div id="partitions-section" style="display: none;" class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">üìÑ Document Content Preview</h5>
                            <small>Showing first 50 sections while processing continues...</small>
                        </div>
                        <div class="card-body">
                            <div id="partitions-container" class="accordion">
                                <!-- Partitions will be populated here -->
                            </div>
                            <div id="partitions-loading" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading document content...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Semantic Search Results Section -->
                    <div id="search-section" style="display: none;" class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">üîç Semantic Search Results</h5>
                            <small>Relevant document sections found - extracting quotes...</small>
                        </div>
                        <div class="card-body">
                            <div id="search-container" class="accordion">
                                <!-- Search results will be populated here -->
                            </div>
                            <div id="search-loading" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Performing semantic search...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Extracted Quotes Section -->
                    <div id="quotes-section" style="display: none;" class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">üí¨ Extracted Quotes</h5>
                            <small>Relevant quotes found - classification in progress...</small>
                        </div>
                        <div class="card-body">
                            <div id="quotes-container" class="accordion">
                                <!-- Quotes will be populated here -->
                            </div>
                            <div id="quotes-loading" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Extracting quotes...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Classification Results Section -->
                    <div id="classification-section" style="display: none;" class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">üè∑Ô∏è AI Classification Results</h5>
                            <small>Quotes have been classified into categories</small>
                        </div>
                        <div class="card-body">
                            <div id="classification-container">
                                <!-- Classification results will be populated here -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="connection-status" id="connection-status">
            Connected ‚Ä¢ Last update: <span id="last-update">--</span>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const taskId = '{{ task_id }}';
        let pollInterval = 2000;
        let maxRetries = 20;
        let retryCount = 0;
        let consecutiveFailures = 0;
        let lastSuccessfulUpdate = Date.now();
        let isShowingError = false;
        let heartbeatInterval;
        let partitionsLoaded = false;
        let quotesLoaded = false;
        let classificationLoaded = false;
        let lastPartialResultsCheck = 0;
        let searchResultsLoaded = false;

        function startHeartbeat(taskId) {
            heartbeatInterval = setInterval(() => {
                fetch(`/api/heartbeat/${taskId}`, {method: 'POST'})
                    .catch(err => {
                        console.log('Heartbeat failed:', err);
                        clearInterval(heartbeatInterval);
                    });
            }, 30000); // Every 30 seconds
        }

        // Release queue on page unload (browser close)
        window.addEventListener('beforeunload', function() {
            if (typeof taskId !== 'undefined') {
                // Use sendBeacon for reliable delivery on page unload
                navigator.sendBeacon(`/api/release-slot/${taskId}`, '');
            }
        });

        // Start heartbeat for current task
        if (typeof taskId !== 'undefined') {
            startHeartbeat(taskId);
        }

        function showProgressDisplay() {
            const progressContainer = document.querySelector('.progress-container');
            const infoBanner = document.querySelector('.alert-info');
            
            if (progressContainer) progressContainer.style.display = 'block';
            if (infoBanner) infoBanner.style.display = 'block';
            
            // Hide error container
            const errorContainer = document.getElementById('error-container');
            if (errorContainer) errorContainer.style.display = 'none';
            
            isShowingError = false;
        }

        function hideErrorDisplay() {
            const errorContainer = document.getElementById('error-container');
            if (errorContainer) errorContainer.style.display = 'none';
            isShowingError = false;
        }

        function hideInfoBanner() {
            const infoBanner = document.querySelector('.alert-info');
            if (infoBanner) {
                infoBanner.style.display = 'none';
            }
        }

        function copyErrorToClipboard() {
            try {
                const taskId = '{{ task_id }}';
                const filename = '{{ original_filename }}' || 'unknown_document';
                const timestamp = new Date().toISOString();
                
                // Get error details from the page
                const errorTitle = document.querySelector('.alert-danger h4')?.textContent || 'Unknown Error';
                const errorMessage = document.querySelector('.alert-danger p strong')?.textContent || 'No error message';
                const consoleLog = getConsoleLog();
                
                // Get traceback if available
                const tracebackElement = document.querySelector('details pre');
                const traceback = tracebackElement ? tracebackElement.textContent : 'No traceback available';
                
                // Create comprehensive error report
                const errorReport = `
TRANSPORT POLICY MINER - ERROR REPORT
=====================================
Timestamp: ${timestamp}
Task ID: ${taskId}
Document: ${filename}

ERROR DETAILS:
${errorTitle}
${errorMessage}

CONSOLE LOG:
${consoleLog}

FULL TRACEBACK:
${traceback}

SYSTEM INFO:
Browser: ${navigator.userAgent}
URL: ${window.location.href}
=====================================
                `.trim();
                
                // Copy to clipboard
                navigator.clipboard.writeText(errorReport).then(() => {
                    // Show success feedback
                    const copyBtn = document.getElementById('copy-error-btn');
                    if (copyBtn) {
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '‚úÖ Copied!';
                        copyBtn.className = 'btn btn-success btn-sm';
                        
                        // Reset after 2 seconds
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                            copyBtn.className = 'btn btn-outline-secondary btn-sm';
                        }, 2000);
                    }
                    
                    logToUser('[ACTION] Error details copied to clipboard');
                }).catch(err => {
                    // Fallback for older browsers
                    logToUser('[ERROR] Could not copy to clipboard: ' + err.message);
                    
                    // Create a text area for manual copy
                    const textArea = document.createElement('textarea');
                    textArea.value = errorReport;
                    document.body.appendChild(textArea);
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        logToUser('[ACTION] Error details selected - please press Ctrl+C to copy');
                    } catch (fallbackErr) {
                        logToUser('[ERROR] Manual copy also failed: ' + fallbackErr.message);
                    }
                    
                    document.body.removeChild(textArea);
                });
            } catch (error) {
                logToUser('[ERROR] Copy function failed: ' + error.message);
            }
        }

        function showErrorMessage(title, message, suggestions, isProcessingError, traceback = null, hasPartialResults = false) {
            console.log('showErrorMessage called with:', {title, message, hasPartialResults});
            isShowingError = true;
            
            // Hide progress container
            //const progressContainer = document.querySelector('.progress-container');
            //console.log('Progress container found:', !!progressContainer);
            //if (progressContainer) {
            //    progressContainer.style.display = 'none';
            //    console.log('Progress container hidden');
            //}

            // Show or create error container
            let errorContainer = document.getElementById('error-container');
            console.log('Error container found:', !!errorContainer);
            console.log('Error container current display:', errorContainer ? errorContainer.style.display : 'N/A');
    
            if (errorContainer) {
                errorContainer.innerHTML = `
                    <div class="alert alert-danger" style="background: red; color: white; padding: 20px;">
                        <h1>TEST ERROR MESSAGE</h1>
                        <p>This is a test to see if error display works</p>
                        <p>Title: ${title}</p>
                        <p>Message: ${message}</p>
                        <p>hasPartialResults: ${hasPartialResults}</p>
                    </div>
                `;
                errorContainer.style.display = 'block';
                console.log('Error container updated and shown');
                console.log('Error container final display:', errorContainer.style.display);
            } else {
                console.error('ERROR CONTAINER NOT FOUND!');
            }

            if (!errorContainer) {
                errorContainer = document.createElement('div');
                errorContainer.id = 'error-container';
                errorContainer.className = 'mt-4';
                
                // Insert after progress container or at end of card body
                const cardBody = document.querySelector('.card-body');
                const progressContainer = document.querySelector('.progress-container');
                
                if (progressContainer && progressContainer.parentNode) {
                    progressContainer.parentNode.insertBefore(errorContainer, progressContainer.nextSibling);
                } else if (cardBody) {
                    cardBody.appendChild(errorContainer);
                }
            }
            
            // Update error content
            const errorHtml = `
                <div class="alert alert-danger" role="alert">
                    <h4>${title}</h4>
                    <p><strong>${message}</strong></p>
                    
                    <h6 class="mt-3">What you can do:</h6>
                    <ul>
                        ${suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                    </ul>
                    
                    ${hasPartialResults ? `
                        <div class="alert alert-warning mt-3">
                            <strong>üì¶ Partial Results Available</strong><br>
                            Some processing steps completed before the error. You can download what was processed.
                        </div>
                        <button class="btn btn-warning me-2" onclick="downloadPartialResults()">
                                üì¶ Download Partial Results
                        </button>
                    ` : ''}
                    
                    <div class="mt-3">
                        <h6>üîç Live Console Log:</h6>
                        <div id="console-log" style="background: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; border: 1px solid #dee2e6; white-space: pre-wrap;">
                            ${getConsoleLog()}
                        </div>
                    </div>

                    <button id="copy-error-btn" class="btn btn-outline-secondary btn-sm" onclick="copyErrorToClipboard()">
                            üìã Copy Error Details
                    </button>
                    
                    ${traceback ? `
                        <details class="mt-3">
                            <summary><strong>Full Error Details</strong></summary>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap;">${traceback}</pre>
                        </details>
                    ` : ''}
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-primary" onclick="location.reload()">
                            üîÑ Try Again
                        </button>
                        <a href="/" class="btn btn-primary">
                            üè† Return to Home
                        </a>
                    </div>
                </div>
            `;
            
            errorContainer.innerHTML = errorHtml;
            errorContainer.style.display = 'block';
        }

        function showConnectionError(errorType) {
            if (isShowingError) return; // Don't spam error messages
            
            const progressContainer = document.querySelector('.progress-container');
            const infoBanner = document.querySelector('.alert-info');
            
            // Hide progress and info banner
            if (progressContainer) progressContainer.style.display = 'none';
            if (infoBanner) infoBanner.style.display = 'none';
            
            let errorTitle, errorMessage, suggestions;
            
            switch(errorType) {
                case 'network':
                    errorTitle = "üåê Network Connection Lost";
                    errorMessage = "Cannot reach the server. Your internet connection may be unstable.";
                    suggestions = [
                        "Check your internet connection",
                        "Refresh the page to restart",
                        "Contact support if this persists"
                    ];
                    break;
                case 'timeout':
                    errorTitle = "‚è∞ Server Not Responding";
                    errorMessage = "The server is taking too long to respond. It may be overloaded or processing a very large document.";
                    suggestions = [
                        "Wait a few more minutes - the process might still be running",
                        "Try refreshing to check current status",
                        "Consider using a smaller document if this persists"
                    ];
                    break;
                default:
                    errorTitle = "‚ö†Ô∏è Connection Problems";
                    errorMessage = "Having trouble communicating with the server.";
                    suggestions = [
                        "This might be temporary",
                        "We'll keep trying automatically",
                        "Check the console log below for details"
                    ];
            }
            
            showErrorMessage(errorTitle, errorMessage, suggestions, false);
        }

        function showProcessingError(error, traceback, hasPartialResults) {
            hideInfoBanner();
            
            const errorTitle = "‚ùå Document Processing Failed";
            const errorMessage = `Processing was interrupted: ${error}`;
            const suggestions = [
                "Try processing a smaller document",
                "Check if your document is corrupted",
                "Contact support with the error details below"
            ];
            
            showErrorMessage(errorTitle, errorMessage, suggestions, true, traceback, hasPartialResults);
        }

        function showCriticalError() {
            hideInfoBanner();
            
            const errorTitle = "üö® Connection Failed Completely";
            const errorMessage = "Cannot establish connection to the server after multiple attempts.";
            const suggestions = [
                "The application may have crashed",
                "Your document might be too large to process",
                "Try refreshing the page and using a smaller document",
                "Contact support if this problem persists"
            ];
            
            showErrorMessage(errorTitle, errorMessage, suggestions, true);
        }

        // Console logging for user visibility
        let consoleLog = [];
        function logToUser(message) {
            console.log(message); // Still log to browser console
            
            const timestamp = new Date().toLocaleTimeString();
            consoleLog.push(`[${timestamp}] ${message}`);
            
            // Keep only last 25 messages
            if (consoleLog.length > 25) {
                consoleLog.shift();
            }
            
            // Update console display if it's visible
            const consoleDiv = document.getElementById('console-log');
            if (consoleDiv) {
                consoleDiv.textContent = consoleLog.join('\n');
                consoleDiv.scrollTop = consoleDiv.scrollHeight; // Auto-scroll to bottom
            }
        }

        function getConsoleLog() {
            return consoleLog.join('\n') || 'No log entries yet...';
        }

        function updateProgressDisplay(progress, status) {
            try {
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                    progressBar.textContent = progress + '%';
                }
                
                const statusText = document.getElementById('status-text');
                if (statusText) {
                    statusText.textContent = status;
                }

                document.title = `${progress}% - Processing Document`;
            } catch (error) {
                logToUser(`ERROR: Failed to update progress display: ${error.message}`);
            }
        }

        function updateConnectionStatus(status) {
            try {
                const connectionEl = document.getElementById('connection-status');
                if (connectionEl) {
                    const now = new Date().toLocaleTimeString();
                    connectionEl.innerHTML = `${status} ‚Ä¢ Last update: ${now}`;
                }
            } catch (error) {
                logToUser(`ERROR: Failed to update connection status: ${error.message}`);
            }
        }

        function displaySearchResults(searchResults, totalCount) {
            const searchSection = document.getElementById('search-section');
            const searchContainer = document.getElementById('search-container');
            const loadingDiv = document.getElementById('search-loading');

            // Hide loading and show section
            loadingDiv.style.display = 'none';
            searchSection.style.display = 'block';

            // Create accordion items for search results
            let html = '';
            searchResults.forEach((result, index) => {
                const pageInfo = result.page || 'Unknown page';
                const score = result.score ? result.score.toFixed(3) : 'Unknown';
                
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="search-heading-${index}">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#search-collapse-${index}">
                                <div>
                                    <span class="badge bg-info me-2">Score: ${score}</span>
                                    ${pageInfo} - ${result.text.substring(0, 80)}...
                                </div>
                            </button>
                        </h2>
                        <div id="search-collapse-${index}" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <p class="text-muted small">Page: ${pageInfo} | Relevance Score: ${score}</p>
                                <div class="text-pre-wrap">${result.text}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add info about total count
            html += `
                <div class="alert alert-info mt-3">
                    <small>Showing ${searchResults.length} of ${totalCount} relevant sections found</small>
                </div>
            `;

            searchContainer.innerHTML = html;
            logToUser(`[DISPLAY] Loaded ${searchResults.length} semantic search results`);
        }

        function downloadPartialResults() {
            const filename = '{{ request.args.get("filename", "analysis") }}' || 'analysis';
            logToUser('ACTION: Downloading partial results...');
            window.location.href = `/download-partial?task_id=${taskId}&filename=${encodeURIComponent(filename)}`;
        }

        function hideAllSections() {
            const sections = ['partitions-section', 'search-section', 'quotes-section', 'classification-section'];
            sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) {
                    element.style.display = 'none';
                }
            });
        }

        function showSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.style.display = 'block';
                // Add smooth transition effect
                element.style.animation = 'fadeIn 0.5s ease-in';
            } else {
                logToUser(`[ERROR] Section ${sectionId} not found!`);
            }
        }

        function getCurrentStage(progress) {
            if (progress >= 80) return 'Classification';
            if (progress >= 60) return 'Quote Extraction';
            if (progress >= 30) return 'Semantic Search';
            if (progress >= 20) return 'Text Partitions';
            return 'Starting';
        }

        function checkPartialResults() {
            // Don't check too frequently
            const now = Date.now();
            if (now - lastPartialResultsCheck < 3000) return; 
            lastPartialResultsCheck = now;

            fetch(`/api/partial-results/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    // Show partial results container if any content is available
                    if (data.text_partitions.length > 0 || data.search_results.length > 0 || data.extracted_quotes || data.classified_quotes.length > 0) {
                        document.getElementById('partial-results-container').style.display = 'block';
                    }

                    // Priority-based replacement (newest/highest priority wins)
                    let currentStage = 'none';
                    
                    // Determine which stage to show (highest priority wins)
                    if (data.classification_complete && data.progress >= 80) {
                        currentStage = 'classification';
                    } else if (data.quote_extraction_complete && data.progress >= 60) {
                        currentStage = 'quotes';
                    } else if (data.search_results && data.search_results.length > 0 && data.progress >= 30) {
                        currentStage = 'search';
                    } else if (data.text_partitions.length > 0 && data.progress >= 20) {
                        currentStage = 'partitions';
                    }

                    // Hide all sections first
                    hideAllSections();

                    // Show the appropriate section based on current stage
                    switch (currentStage) {
                        case 'classification':
                            if (!classificationLoaded) {
                                displayClassificationResults(data.classified_quotes);
                                classificationLoaded = true;
                                logToUser(`[PARTIAL] üè∑Ô∏è Classification results loaded - Stage 4/4`);
                            }
                            showSection('classification-section');
                            break;

                        case 'quotes':
                            if (!quotesLoaded) {
                                displayExtractedQuotes(data.extracted_quotes);
                                quotesLoaded = true;
                                logToUser(`[PARTIAL] üí¨ Extracted quotes loaded - Stage 3/4`);
                            }
                            showSection('quotes-section');
                            break;

                        case 'search':
                            if (!searchResultsLoaded) {
                                displaySearchResults(data.search_results, data.total_search_results);
                                searchResultsLoaded = true;
                                logToUser(`[PARTIAL] üîç Search results loaded - Stage 2/4`);
                            }
                            showSection('search-section');
                            break;

                        case 'partitions':
                            if (!partitionsLoaded) {
                                displayDocumentPartitions(data.text_partitions, data.total_partitions);
                                partitionsLoaded = true;
                                logToUser(`[PARTIAL] üìÑ Document partitions loaded - Stage 1/4`);
                            }
                            showSection('partitions-section');
                            break;

                        default:
                            logToUser(`[PARTIAL] No content ready to display yet...`);
                    }

                    logToUser(`[PARTIAL-DEBUG] Progress: ${data.progress}% | Current Stage: ${currentStage} | Flags: P:${data.text_partitions.length>0} S:${data.search_results?.length>0} Q:${data.quote_extraction_complete} C:${data.classification_complete}`);
                })
                .catch(error => {
                    console.log('Partial results check failed:', error);
                    logToUser(`[PARTIAL-ERROR] ${error.message}`);
                });
        }

        function showSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.style.display = 'block';
                // Add smooth transition effect
                element.style.animation = 'fadeIn 0.5s ease-in';
            } else {
                logToUser(`[ERROR] Section ${sectionId} not found!`);
            }
        }
        function displayDocumentPartitions(partitions, totalCount) {
            const partitionsSection = document.getElementById('partitions-section');
            const partitionsContainer = document.getElementById('partitions-container');
            const loadingDiv = document.getElementById('partitions-loading');

            // Hide loading and show section
            loadingDiv.style.display = 'none';
            partitionsSection.style.display = 'block';

            // Create accordion items for partitions
            let html = '';
            partitions.forEach((partition, index) => {
                const elementType = partition.element_type || 'Text';
                const pageInfo = partition.metadata?.page_number ? `Page ${partition.metadata.page_number}` : 'Unknown page';
                
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="partition-heading-${index}">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#partition-collapse-${index}">
                                <div>
                                    <span class="badge bg-secondary me-2">${elementType}</span>
                                    ${pageInfo} - ${partition.text.substring(0, 100)}...
                                </div>
                            </button>
                        </h2>
                        <div id="partition-collapse-${index}" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <p class="text-muted small">Type: ${elementType} | ${pageInfo}</p>
                                <div class="text-pre-wrap">${partition.text}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add info about total count
            html += `
                <div class="alert alert-info mt-3">
                    <small>Showing first ${partitions.length} of ${totalCount} document sections</small>
                </div>
            `;

            partitionsContainer.innerHTML = html;
            logToUser(`[DISPLAY] Loaded ${partitions.length} document partitions for preview`);
        }

        function displayExtractedQuotes(quotesData) {
            const quotesSection = document.getElementById('quotes-section');
            const quotesContainer = document.getElementById('quotes-container');
            const loadingDiv = document.getElementById('quotes-loading');

            // Hide loading and show section
            loadingDiv.style.display = 'none';
            quotesSection.style.display = 'block';

            // Create accordion items for quotes (similar to results.html structure)
            let html = '';
            let quoteIndex = 0;
            let totalVerified = 0;
            let totalUnverified = 0;
            
            for (const [index, item] of Object.entries(quotesData)) {
                if (item.quotes && item.quotes.length > 0) {
                    // Count verified vs unverified quotes for this source
                    let verifiedCount = 0;
                    let unverifiedCount = 0;
                    
                    item.quotes.forEach(quote => {
                        const isVerified = quote.length > 2 ? quote[2] : true;
                        if (isVerified) {
                            verifiedCount++;
                            totalVerified++;
                        } else {
                            unverifiedCount++;
                            totalUnverified++;
                        }
                    });
                    
                    html += `
                        <div class="accordion-item mb-2">
                            <h2 class="accordion-header" id="quote-heading-${quoteIndex}">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#quote-collapse-${quoteIndex}">
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <span>Page ${item.page_number} - Relevance: ${item.score.toFixed(2)}</span>
                                        <div class="ms-auto me-3">
                                            <span class="badge rounded-pill bg-success">${verifiedCount} verified</span>
                                            ${unverifiedCount > 0 ? `<span class="badge rounded-pill bg-danger ms-1">${unverifiedCount} unverified</span>` : ''}
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="quote-collapse-${quoteIndex}" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="card mb-3">
                                        <div class="card-header text-white" style="background: linear-gradient(135deg, #198754 0%, #20c997 100%);">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0"> Extracted Quotes</h6>
                                                <span class="badge bg-light text-dark">${item.quotes.length} total</span>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            ${item.quotes.map(quote => {
                                                const quoteIndex = quote[0];
                                                const quoteText = quote[1];
                                                const isVerified = quote.length > 2 ? quote[2] : true;
                                                
                                                return `
                                                    <div class="quote-item mb-3 p-3 rounded ${isVerified ? 'verified-quote' : 'unverified-quote'}">
                                                        <div class="quote-header d-flex justify-content-between align-items-start mb-2">
                                                            <div class="verification-badge">
                                                                ${isVerified 
                                                                    ? '<span class="badge bg-success me-2">‚úì Verified</span>' 
                                                                    : '<span class="badge bg-danger me-2">‚ö† Unverified</span>'}
                                                            </div>
                                                            <small class="text-muted">Position: ${quoteIndex}</small>
                                                        </div>
                                                        <div class="quote-text ${isVerified ? 'text-dark' : 'text-danger'}" 
                                                            style="font-style: italic; font-weight: 500;">
                                                            ${quoteText}
                                                        </div>
                                                        ${!isVerified ? `
                                                            <div class="alert alert-warning mt-2 py-2 mb-0">
                                                                <small>
                                                                    <strong>‚ö† Attention:</strong> This quote could not be verified in the original document. 
                                                                    It may contain minor text extraction issues.
                                                                </small>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">Full Context</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="text-pre-wrap" style="white-space: pre-wrap;">${item.content}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    quoteIndex++;
                }
            }

            if (html === '') {
                html = '<div class="alert alert-warning">No quotes were extracted from this document.</div>';
            } else {
                // Add summary statistics at the top
                html = `
                    <div class="alert alert-info mb-3">
                        <strong>üìä Quote Statistics:</strong> 
                        ${totalVerified} verified quotes
                    </div>
                ` + html;
            }

            quotesContainer.innerHTML = html;
            logToUser(`[DISPLAY] Loaded ${totalVerified} verified quotes`);
        }

        function displayClassificationResults(classifiedData) {
            const classificationSection = document.getElementById('classification-section');
            const classificationContainer = document.getElementById('classification-container');

            // Show section
            classificationSection.style.display = 'block';

            // Create summary of classification results
            const categories = {};
            classifiedData.forEach(item => {
                // Count quotes by category
                if (item.target === 'True') categories['Targets'] = (categories['Targets'] || 0) + 1;
                if (item.mitigation_measure === 'True') categories['Mitigation'] = (categories['Mitigation'] || 0) + 1;
                if (item.adaptation_measure === 'True') categories['Adaptation'] = (categories['Adaptation'] || 0) + 1;
            });
            
            // Color mapping for categories
            const categoryColors = {
                'Targets': { bg: 'bg-info', text: 'text-dark', icon: 'üéØ' },
                'Mitigation': { bg: 'bg-warning', text: 'text-dark', icon: 'üõ°Ô∏è' },
                'Adaptation': { bg: 'bg-warning', text: 'text-dark', icon: 'üåø' }
            };

            let html = `
                <div class="row">
                    <div class="col-md-12">
                        <h6>Classification Summary:</h6>
                        <div class="row">
            `;

            for (const [category, count] of Object.entries(categories)) {
                const colors = categoryColors[category] || { bg: 'bg-secondary', text: 'text-white', icon: 'üìä' };
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="card ${colors.bg} ${colors.text}">
                            <div class="card-body text-center">
                                <div style="font-size: 2rem;">${colors.icon}</div>
                                <h5 class="card-title">${count}</h5>
                                <p class="card-text">${category}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `
                        </div>
                        <div class="alert alert-success">
                            <strong>üéâ Classification Complete!</strong> All quotes have been categorized. 
                            Click "View Full Results" when processing finishes to see detailed classifications.
                        </div>
                    </div>
                </div>
            `;

            classificationContainer.innerHTML = html;
            logToUser(`[DISPLAY] Classification results loaded`);
        }

        function updateProgress() {
            const timestamp = new Date().toISOString();
            logToUser(`[${timestamp}] Checking progress...`);
            
            fetch(`/api/progress/${taskId}`, {
                method: 'GET',
                headers: { 
                    'Cache-Control': 'no-cache',
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                logToUser(`[${timestamp}] Server responded with status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                const timestamp = new Date().toLocaleTimeString();
                logToUser(`[${timestamp}] Received progress: ${data.progress}% - ${data.status}`);
                
                // Reset failure counters on success
                retryCount = 0;
                consecutiveFailures = 0;
                lastSuccessfulUpdate = Date.now();
                
                // Check for failure state 
                if (data.failed === true || data.error) {
                    logToUser(`[ERROR] Processing failed: ${data.error || 'Unknown error'}`);
                    showProcessingError(
                        data.error || 'Unknown error occurred', 
                        data.traceback || 'No traceback available', 
                        data.has_partial_results || false
                    );
                    return; // STOP HERE - don't continue polling
                }
                
                // Update connection status
                updateConnectionStatus('‚úÖ Connected and receiving updates');
                
                // Validate data structure
                if (typeof data.progress === 'undefined' || data.progress === null) {
                    throw new Error('Invalid progress data received from server');
                }
                
                // Hide any error displays and show progress again
                hideErrorDisplay();
                showProgressDisplay();
                
                // Update progress display safely
                try {
                    updateProgressDisplay(data.progress, data.status || `Processing... ${data.progress}%`);
                    
                    // Check for partial results
                    checkPartialResults();
                } catch (displayError) {
                    logToUser(`[WARNING] Display update failed: ${displayError.message}`);
                    // Continue anyway - don't let display errors stop polling
                }
                
                // Check for completion
                if (data.completed === true && data.redirect) {
                    logToUser('[SUCCESS] Processing completed successfully! Redirecting to results...');
                    document.getElementById('status-text').textContent = '‚úÖ Analysis Complete! Redirecting...';
                    hideInfoBanner();
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 2000);
                    return; // STOP polling - we're redirecting
                }
                
                // ALWAYS continue polling unless we explicitly returned above
                setTimeout(updateProgress, pollInterval);
            })
            .catch(error => {
                consecutiveFailures++;
                retryCount++;
                
                const errorMsg = `Connection attempt ${retryCount}/${maxRetries} failed: ${error.message}`;
                logToUser(`[ERROR] ${errorMsg}`);
                
                // Update connection status with specific error type
                if (error.message.includes('Failed to fetch')) {
                    updateConnectionStatus(`‚ùå Network connection lost (${consecutiveFailures} failures)`);
                    showConnectionError('network');
                } else if (error.message.includes('timeout')) {
                    updateConnectionStatus(`‚è∞ Server not responding (${consecutiveFailures} timeouts)`);
                    showConnectionError('timeout');
                } else {
                    updateConnectionStatus(`‚ö†Ô∏è Connection error (${consecutiveFailures} failures)`);
                    showConnectionError('general');
                }
                
                // Check if we should give up
                if (retryCount >= maxRetries) {
                    logToUser(`[CRITICAL] Giving up after ${maxRetries} failed attempts`);
                    showCriticalError();
                } else {
                    const retryDelay = Math.min(1000 * Math.pow(1.5, retryCount), 15000);
                    logToUser(`[RETRY] Will retry in ${(retryDelay/1000).toFixed(1)} seconds...`);
                    setTimeout(updateProgress, retryDelay);
                }
            });
        }

        // Add visibility change handling
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                logToUser('INFO: Tab hidden - continuing background monitoring');
            } else {
                logToUser('INFO: Tab visible - resuming normal updates');
                if (!isShowingError) {
                    updateProgress(); // Force immediate update when tab becomes visible
                }
            }
        });

        // Start the process
        logToUser('INIT: Starting document processing monitor...');
        logToUser(`INIT: Task ID: ${taskId}`);
        logToUser('INIT: Will check progress every 2 seconds...');
        updateProgress();
    </script>

</body>
</html>